### 2 IP协议详解

#### 2.1

ip协议是TCP/ip协议族的动力，它为上层协议提供无状态，无连接、不可靠的服务。

无状态是指IP通信双方不同步传输数据的状态信息，因此所有的ip数据包的发送传输、和接收都是相互独立、没有上下文关系的。面向连接的协议，比如TCP协议，则能够自己处理乱序的重复的报文段，他递交给上层协议的内容绝对是有序的、正确的。

无连接是指ip通信双方都不长久的维持对方任何信息。这样上层协议每次发送数据的时候，都必须明确指定对方的ip地址。

不可靠是指ip协议不能保证ip数据报准确的到达接收端，只是尽最大努力。

#### 2.3ip分片

一个ip数据报只能传输1500字节，如果超出这个大小，则将他们分成两个ip报传输

例如一个1501字节大小的数据

第一个ip数据报传输1500（20字节的ip头部，1480的数据）

第二个ip数据传输1自己大小的信息，但是还是以一个完整的ip数据报的方式发送。就是21自己的ip数据报

那么他们两个的标识值都是相同，根据偏移量来组合到一起。例如第一个偏移量为0，第二个偏移量为1480

#### 2,4IP路由

ip路由机制

* 查找路由表中和数据报的目标ip地址完全匹配的主机ip地址，如果找到就使用该路由项，没找到则转步骤2
* 查找路由表中和数据报的目标ip地址具有相同网路id的网络ip地址，如果找到就使用该路由项，没找到转步骤3
* 选择默认路由项，这通常意味着数据报的下一跳路由是网关。

**路由表更新**

route可以通过命令更改

![image-20211202212656826](C:\Users\mzx\AppData\Roaming\Typora\typora-user-images\image-20211202212656826.png)

这是静态更改，对于其他路由器，通过RIP（routing information protocol路由信息协议），ospf等协议来发现路径，并更新自己的路由表。这种更新方式是动态的自动的。

#### 2.5 IP转发

转发操作

* 检查数据报头部的TTL值，如果TTL（time to live）值已经是0，则丢弃该数据报
* 查看数据报头部的严格源路由选择选项。如果该选项被设置，则检测数据报的目标ip地址是否是本机的某个ip地址，如果不是则发送一个ICMP重定向报文，以告诉他一个更合理的下一跳路由器
* 将TTL值减1
* 处理ip头部选项
* 如果有必要，则执行ip分片操作

#### 2.6重定向

ICMP重定向

主要就两个

* 引起重定向的ip数据报的源端ip地址
* 应该使用的路由器的ip地址



